<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>K·∫øt Qu·∫£ Tr·ª±c Ti·∫øp</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; max-width: 900px; margin: 0 auto; padding: 20px; position: relative; }
        
        /* Ti√™u ƒë·ªÅ Topic l·ªõn */
        #topic-display { 
            text-align: center; color: #e94560; text-transform: uppercase; 
            letter-spacing: 2px; font-size: 2.5em; margin-bottom: 5px; 
            text-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
        }
        .status { text-align: center; color: #aaa; font-style: italic; margin-bottom: 30px; }

        /* N√∫t m·ªü b·∫£ng Reset */
        .btn-toggle-reset {
            position: absolute; top: 20px; right: 20px;
            background: #333; color: #aaa; border: 1px solid #555;
            padding: 5px 10px; cursor: pointer; border-radius: 4px;
        }
        .btn-toggle-reset:hover { color: #fff; border-color: #fff; }

        /* PANEL NH·∫¨P LI·ªÜU (·∫®n m·∫∑c ƒë·ªãnh) */
        #admin-panel {
            display: none; /* ·∫®n */
            background: #16213e; border: 1px solid #e94560;
            padding: 20px; margin-bottom: 20px; border-radius: 8px;
            text-align: center;
        }
        
        /* Input ƒë·∫πp */
        .admin-input {
            padding: 10px; margin: 5px; width: 60%;
            border-radius: 4px; border: none; outline: none;
            font-size: 1em;
        }
        .btn-confirm {
            padding: 10px 20px; background: #e94560; color: white;
            border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .btn-confirm:hover { background: #c0394d; }

        /* ... CSS bi·ªÉu ƒë·ªì gi·ªØ nguy√™n ... */
        .bar-container { margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;}
        .label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold;}
        .progress-bg { background: #333; height: 25px; border-radius: 12px; overflow: hidden;}
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ff9966, #ff5e62); width: 0%; transition: width 1s;}
        .top-1 .progress-fill { background: linear-gradient(90deg, #f1c40f, #f39c12); }
    </style>
</head>
<body>

    <button class="btn-toggle-reset" onclick="toggleAdmin()">‚öôÔ∏è Admin</button>

    <div id="admin-panel">
        <h3 style="margin-top:0">THI·∫æT L·∫¨P V√íNG M·ªöI</h3>
        <input type="text" id="new-topic" class="admin-input" placeholder="Nh·∫≠p n·ªôi dung b·∫ßu ch·ªçn (VD: Ai ƒë·∫πp trai nh·∫•t?)...">
        <br>
        <input type="password" id="admin-pass" class="admin-input" placeholder="M·∫≠t kh·∫©u Admin" style="width: 30%">
        <br><br>
        <button class="btn-confirm" onclick="confirmReset()">üöÄ OK - B·∫ÆT ƒê·∫¶U V√íNG M·ªöI</button>
        <button onclick="toggleAdmin()" style="background:none; border:none; color:#aaa; cursor:pointer; text-decoration:underline">H·ªßy</button>
    </div>

    <h1 id="topic-display">ƒêANG T·∫¢I...</h1>
    
    <div class="status">C·∫≠p nh·∫≠t m·ªói 5 gi√¢y... <span id="timer"></span></div>
    <div id="chart"></div>

    <script>
        // --- THAY LINK API C·ª¶A B·∫†N ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxj2B1XkzBT87WbsRws98AKGVEYB5veURyftkavdtCleaEjec0zVXQJJ1x06co7ZS479A/exec"; 

        // 1. H√†m C·∫≠p nh·∫≠t (T·ª± ƒë·ªông ch·∫°y)
        async function updateResult() {
            try {
                const res = await fetch(API_URL + "?action=getResult");
                const json = await res.json();
                
                if (json.status === "success") {
                    // C·∫¨P NH·∫¨T TI√äU ƒê·ªÄ
                    document.getElementById('topic-display').innerText = json.topic;
                    renderChart(json.ranking);
                }
            } catch (err) { console.log("Waiting..."); }
        }

        // 2. H√†m v·∫Ω bi·ªÉu ƒë·ªì
        function renderChart(ranking) {
            const container = document.getElementById('chart');
            container.innerHTML = ""; 
            if (ranking.length === 0) {
                container.innerHTML = "<p style='text-align:center'>Ch∆∞a c√≥ phi·∫øu b·∫ßu</p>";
                return;
            }
            const maxVote = ranking[0].count;
            ranking.forEach((r, idx) => {
                let percent = (r.count / maxVote) * 100;
                if(percent < 5) percent = 5;
                const div = document.createElement('div');
                div.className = `bar-container ${idx === 0 ? 'top-1' : ''}`;
                div.innerHTML = `
                    <div class="label"><span>#${idx+1} ${r.name}</span><span>${r.count}</span></div>
                    <div class="progress-bg"><div class="progress-fill" style="width: ${percent}%"></div></div>
                `;
                container.appendChild(div);
            });
        }

        // 3. X·ª≠ l√Ω Giao di·ªán Admin
        function toggleAdmin() {
            const panel = document.getElementById('admin-panel');
            panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
        }

        async function confirmReset() {
            const topic = document.getElementById('new-topic').value;
            const pass = document.getElementById('admin-pass').value;

            if (!topic) { alert("Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ!"); return; }
            if (!pass) { alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!"); return; }

            const btn = document.querySelector('.btn-confirm');
            btn.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
            btn.disabled = true;

            try {
                // G·ªçi API g·ª≠i Topic + Pass
                const url = `${API_URL}?action=reset&password=${encodeURIComponent(pass)}&topic=${encodeURIComponent(topic)}`;
                const res = await fetch(url);
                const json = await res.json();

                if (json.status === "success") {
                    alert("‚úÖ Th√†nh c√¥ng! V√≤ng b·∫ßu ch·ªçn m·ªõi ƒë√£ b·∫Øt ƒë·∫ßu.");
                    toggleAdmin(); // ƒê√≥ng b·∫£ng
                    updateResult(); // C·∫≠p nh·∫≠t l·∫°i ngay
                    document.getElementById('new-topic').value = ""; // X√≥a √¥ nh·∫≠p
                } else {
                    alert("‚ùå L·ªói: " + json.message);
                }
            } catch (err) { alert("L·ªói k·∫øt n·ªëi!"); }
            
            btn.innerText = "üöÄ OK - B·∫ÆT ƒê·∫¶U V√íNG M·ªöI";
            btn.disabled = false;
        }

        // Ch·∫°y
        updateResult();
        setInterval(updateResult, 5000);
    </script>
</body>
</html>
