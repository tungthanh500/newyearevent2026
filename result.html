<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt Qu·∫£ Tr·ª±c Ti·∫øp</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #1a1a2e; /* N·ªÅn t·ªëi */
            color: #fff;
            position: relative;
        }

        h1 { 
            text-align: center; 
            color: #e94560; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .status { 
            text-align: center; 
            font-size: 0.9em; 
            color: #a0a0a0; 
            margin-bottom: 30px; 
            font-style: italic;
        }

        /* N√∫t Reset g√≥c ph·∫£i */
        .btn-reset {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #d9534f;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.6;
            transition: 0.3s;
            z-index: 100;
        }
        .btn-reset:hover { opacity: 1; transform: scale(1.05); }

        /* Khung ch·ª©a bi·ªÉu ƒë·ªì */
        #chart { padding: 10px; }

        /* Item t·ª´ng ng∆∞·ªùi */
        .bar-container { 
            margin-bottom: 20px; 
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 12px;
        }

        .label { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
            font-size: 1.1em;
            font-weight: bold;
        }

        /* Thanh Progress Bar */
        .progress-bg { 
            background: #333; 
            border-radius: 10px; 
            height: 25px; 
            width: 100%;
            overflow: hidden; 
            position: relative;
        }

        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #ff9966, #ff5e62); 
            width: 0%; 
            transition: width 1s ease-in-out; /* Hi·ªáu ·ª©ng tr∆∞·ª£t m∆∞·ª£t */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 94, 98, 0.5);
        }

        /* Top 1 Highlight */
        .top-1 .progress-fill { background: linear-gradient(90deg, #f1c40f, #f39c12); }
        .top-1 .label { color: #f1c40f; }

        /* Hi·ªáu ·ª©ng loading */
        .loading-text { text-align: center; margin-top: 50px; color: #666; }

    </style>
</head>
<body>

    <button class="btn-reset" onclick="handleReset()">‚ö†Ô∏è RESET DATA</button>

    <h1>üèÜ B·∫¢NG X·∫æP H·∫†NG</h1>
    <div class="status">
        C·∫≠p nh·∫≠t t·ª± ƒë·ªông m·ªói 5 gi√¢y... 
        <span id="last-updated" style="color: #4cd137"></span>
    </div>

    <div id="chart">
        <div class="loading-text">‚è≥ ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</div>
    </div>

    <script>
        // --- C·∫§U H√åNH QUAN TR·ªåNG ---
        // Thay link Web App c·ªßa b·∫°n v√†o ƒë√¢y (Link c√≥ ƒëu√¥i /exec)
        const API_URL = "https://script.google.com/macros/s/AKfycby...CHANGE_ME.../exec"; 

        const REFRESH_RATE = 5000; // 5000ms = 5 gi√¢y

        // H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu
        async function updateResult() {
            try {
                // G·ªçi API l·∫•y k·∫øt qu·∫£
                const res = await fetch(API_URL + "?action=getResult");
                const json = await res.json();
                
                if (json.status === "success") {
                    renderChart(json.ranking);
                    
                    // C·∫≠p nh·∫≠t gi·ªù hi·ªÉn th·ªã
                    const now = new Date();
                    document.getElementById('last-updated').innerText = 
                        now.toLocaleTimeString();
                }
            } catch (err) {
                console.log("ƒêang ch·ªù k·∫øt n·ªëi...");
            }
        }

        // H√†m v·∫Ω bi·ªÉu ƒë·ªì
        function renderChart(ranking) {
            const container = document.getElementById('chart');
            
            if (ranking.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#888; margin-top:30px'>Ch∆∞a c√≥ phi·∫øu b·∫ßu n√†o.</p>";
                return;
            }

            // X√≥a loading c≈© (n·∫øu c√≥) nh∆∞ng gi·ªØ nguy√™n c·∫•u tr√∫c ƒë·ªÉ update m∆∞·ª£t h∆°n
            // (·ªû ƒë√¢y m√¨nh ch·ªçn c√°ch x√≥a ƒëi v·∫Ω l·∫°i cho ƒë∆°n gi·∫£n code)
            container.innerHTML = "";

            const maxVote = ranking[0].count; // L·∫•y s·ªë phi·∫øu cao nh·∫•t ƒë·ªÉ t√≠nh %

            ranking.forEach((r, idx) => {
                // T√≠nh ph·∫ßn trƒÉm chi·ªÅu d√†i thanh bar
                let percent = (r.count / maxVote) * 100;
                // N·∫øu √≠t phi·∫øu qu√° th√¨ ƒë·ªÉ t·ªëi thi·ªÉu 5% cho ƒë·∫πp
                if(percent < 5) percent = 5;

                const isTop1 = idx === 0 ? "top-1" : "";
                
                const div = document.createElement('div');
                div.className = `bar-container ${isTop1}`;
                div.innerHTML = `
                    <div class="label">
                        <span>#${idx + 1} ${r.name}</span>
                        <span>${r.count} phi·∫øu</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // H√†m x·ª≠ l√Ω n√∫t Reset
        async function handleReset() {
            // 1. H·ªèi m·∫≠t kh·∫©u
            let password = prompt("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA TO√ÄN B·ªò k·∫øt qu·∫£ kh√¥ng?\n\nNh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ x√°c nh·∫≠n:");
            
            if (!password) return; // Ng∆∞·ªùi d√πng b·∫•m H·ªßy

            // 2. G·ª≠i l·ªánh reset l√™n Server
            try {
                const btn = document.querySelector('.btn-reset');
                btn.innerText = "ƒêang x√≥a...";
                
                let res = await fetch(API_URL + "?action=reset&password=" + encodeURIComponent(password));
                let json = await res.json();

                if (json.status === "success") {
                    alert("‚úÖ " + json.message);
                    updateResult(); // C·∫≠p nh·∫≠t l·∫°i ngay l·∫≠p t·ª©c
                } else {
                    alert("‚ùå L·ªói: " + json.message);
                }
                
                btn.innerText = "‚ö†Ô∏è RESET DATA";
            } catch (err) {
                alert("L·ªói k·∫øt n·ªëi server!");
                document.querySelector('.btn-reset').innerText = "‚ö†Ô∏è RESET DATA";
            }
        }

        // --- KH·ªûI CH·∫†Y ---
        updateResult(); // Ch·∫°y ngay l·∫ßn ƒë·∫ßu
        setInterval(updateResult, REFRESH_RATE); // L·∫∑p l·∫°i m·ªói 5s

    </script>
</body>
</html>
