<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng B√¨nh Ch·ªçn Online</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; min-height: 100vh; margin: 0; padding-top: 20px; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 95%; max-width: 480px; text-align: center; }
        .btn { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:disabled { background: #ccc; cursor: default; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;}
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <div id="loader" class="loader hidden"></div>
    
    <div id="screen-login">
        <h2>üëã B·∫°n l√† ai?</h2>
        <div id="user-list">ƒêang t·∫£i danh s√°ch...</div>
    </div>

    <div id="screen-admin" class="hidden">
        <h2 style="color:#d63384">QU·∫¢N TR·ªä VI√äN</h2>
        <input type="text" id="question-input" placeholder="Nh·∫≠p c√¢u h·ªèi m·ªõi...">
        <button class="btn btn-primary" onclick="setQuestion()">üöÄ B·∫Øt ƒë·∫ßu b√¨nh ch·ªçn m·ªõi</button>
        <hr>
        <p>Ti·∫øn ƒë·ªô: <span id="admin-progress">0</span> ng∆∞·ªùi ƒë√£ ch·ªçn</p>
        <button class="btn btn-success" onclick="refreshData(true)">üîÑ C·∫≠p nh·∫≠t Ti·∫øn ƒë·ªô</button>
        <button class="btn btn-primary" onclick="showResultScreen()">üèÜ SHOW K·∫æT QU·∫¢</button>
    </div>

    <div id="screen-vote" class="hidden">
        <h3>Xin ch√†o, <span id="current-user"></span></h3>
        <div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <small>C√¢u h·ªèi:</small><br>
            <b id="vote-question" style="color: #007bff; font-size: 1.2em;">...</b>
        </div>
        <p>Ch·ªçn 1 ng∆∞·ªùi (tr·ª´ b·∫°n):</p>
        <div id="vote-options"></div>
    </div>

    <div id="screen-result" class="hidden">
        <h1>üèÜ K·∫æT QU·∫¢ üèÜ</h1>
        <p id="result-question" style="font-style: italic;"></p>
        <div id="result-board"></div>
        <button class="btn btn-primary" onclick="location.reload()">Tr·ªü v·ªÅ m√†n h√¨nh ch√≠nh</button>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH ---
    // QUAN TR·ªåNG: D√°n link Web App c·ªßa b·∫°n v√†o ƒë√¢y
    const API_URL = "https://script.google.com/macros/s/AKfycbznLgW4N1ptTEX_yDb7J6J8RzwYVAnm8aIga9jxW3IWZ204Ze_B_uItQdgxdjV6FsZu5A/exec"; 
    
    const ADMIN_NAME = "Admin"; // T√™n Admin trong Google Sheet
    let currentUser = "";
    let appData = {};

    // --- LOGIC ---

    // 1. Kh·ªüi ƒë·ªông: L·∫•y d·ªØ li·ªáu t·ª´ Sheet
    async function init() {
        showLoader(true);
        try {
            // Th√™m tham s·ªë action=getData
            const res = await fetch(API_URL + "?action=getData");
            const data = await res.json();
            appData = data;
            renderUserList(data.users);
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi: " + e);
        }
        showLoader(false);
    }

    // Hi·ªÉn th·ªã danh s√°ch user ƒë·ªÉ ƒëƒÉng nh·∫≠p
    function renderUserList(users) {
        const list = document.getElementById('user-list');
        list.innerHTML = "";
        users.forEach(u => {
            const btn = document.createElement('button');
            btn.className = "btn " + (u.hasVoted ? "btn-disabled" : "btn-primary");
            btn.style.backgroundColor = u.hasVoted ? "#ccc" : "";
            btn.innerText = u.name + (u.hasVoted ? " (ƒê√£ ch·ªçn)" : "");
            
            // N·∫øu ƒë√£ ch·ªçn r·ªìi th√¨ kh√¥ng cho v√†o n·ªØa (tr·ª´ Admin)
            if(u.hasVoted && u.name !== ADMIN_NAME) {
                btn.disabled = true;
            }

            btn.onclick = () => handleLogin(u.name);
            list.appendChild(btn);
        });
    }

    function handleLogin(name) {
        currentUser = name;
        document.getElementById('screen-login').classList.add('hidden');

        if (name === ADMIN_NAME) {
            document.getElementById('screen-admin').classList.remove('hidden');
            refreshData(true); // Admin v√†o th√¨ load l·∫°i s·ªë li·ªáu m·ªõi nh·∫•t
        } else {
            setupVoteScreen();
        }
    }

    // Thi·∫øt l·∫≠p m√†n h√¨nh b√¨nh ch·ªçn
    function setupVoteScreen() {
        document.getElementById('screen-vote').classList.remove('hidden');
        document.getElementById('current-user').innerText = currentUser;
        document.getElementById('vote-question').innerText = appData.question || "(Ch∆∞a c√≥ c√¢u h·ªèi)";

        const optionsDiv = document.getElementById('vote-options');
        optionsDiv.innerHTML = "";

        if (!appData.question) {
            optionsDiv.innerHTML = "<p>Admin ch∆∞a t·∫°o c√¢u h·ªèi. Vui l√≤ng quay l·∫°i sau.</p>";
            return;
        }

        appData.users.forEach(u => {
            if (u.name !== currentUser && u.name !== ADMIN_NAME) { // Kh√¥ng hi·ªán Admin & B·∫£n th√¢n
                const btn = document.createElement('button');
                btn.className = "btn";
                btn.style.border = "1px solid #ccc";
                btn.innerText = u.name;
                btn.onclick = () => submitVote(u.name);
                optionsDiv.appendChild(btn);
            }
        });
    }

    // G·ª≠i vote l√™n Google Sheet
    async function submitVote(voteFor) {
        if (!confirm("Ch·ªçn " + voteFor + "?")) return;
        
        showLoader(true);
        // G·ª≠i POST request
        await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors', // Quan tr·ªçng ƒë·ªÉ g·ª≠i form t·ªõi Google Script
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'vote', user: currentUser, voteFor: voteFor })
        });

        // V√¨ mode 'no-cors' kh√¥ng tr·∫£ v·ªÅ response ƒë·ªçc ƒë∆∞·ª£c, ta gi·∫£ ƒë·ªãnh th√†nh c√¥ng
        alert("ƒê√£ g·ª≠i l·ª±a ch·ªçn!");
        location.reload(); 
    }

    // Admin: T·∫°o c√¢u h·ªèi m·ªõi
    async function setQuestion() {
        const q = document.getElementById('question-input').value;
        if (!q) return alert("Nh·∫≠p c√¢u h·ªèi!");
        
        if(!confirm("H√†nh ƒë·ªông n√†y s·∫Ω X√ìA h·∫øt k·∫øt qu·∫£ c≈©. Ti·∫øp t·ª•c?")) return;

        showLoader(true);
        await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'setQuestion', question: q })
        });
        
        alert("ƒê√£ t·∫°o c√¢u h·ªèi m·ªõi!");
        refreshData(true); // Load l·∫°i d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán admin
    }

    // Admin: L√†m m·ªõi d·ªØ li·ªáu (Pull data m·ªõi nh·∫•t)
    async function refreshData(stayInAdmin = false) {
        showLoader(true);
        const res = await fetch(API_URL + "?action=getData");
        const data = await res.json();
        appData = data;
        
        // C·∫≠p nh·∫≠t s·ªë li·ªáu admin
        const votedCount = data.users.filter(u => u.hasVoted).length;
        document.getElementById('admin-progress').innerText = votedCount;
        
        showLoader(false);
        if(!stayInAdmin) renderUserList(data.users);
    }

    // Hi·ªÉn th·ªã m√†n h√¨nh k·∫øt qu·∫£
    function showResultScreen() {
        document.getElementById('screen-admin').classList.add('hidden');
        document.getElementById('screen-result').classList.remove('hidden');
        
        document.getElementById('result-question').innerText = appData.question;
        const board = document.getElementById('result-board');
        board.innerHTML = "";

        // S·∫Øp x·∫øp k·∫øt qu·∫£
        let sorted = Object.entries(appData.results).sort((a,b) => b[1] - a[1]);
        
        if(sorted.length === 0) board.innerHTML = "<p>Ch∆∞a c√≥ ai b√¨nh ch·ªçn</p>";

        sorted.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = "result-item";
            let rank = idx + 1;
            let style = (rank === 1) ? "color:green; font-weight:bold; font-size:1.2em;" : "";
            div.innerHTML = `<span style="${style}">#${rank} ${item[0]}</span> <b>${item[1]} phi·∫øu</b>`;
            board.appendChild(div);
        });
    }

    function showLoader(show) {
        if(show) document.getElementById('loader').classList.remove('hidden');
        else document.getElementById('loader').classList.add('hidden');
    }

    // Ch·∫°y
    // T√¨m h√†m init() c≈© v√† thay b·∫±ng ƒëo·∫°n n√†y
    async function init() {
        showLoader(true);
        try {
            const res = await fetch(API_URL + "?action=getData");
            const data = await res.json();
            
            // --- TH√äM ƒêO·∫†N KI·ªÇM TRA L·ªñI N√ÄY ---
            if (!data.success) {
                alert("L·ªói t·ª´ Google Sheet: " + (data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu"));
                console.error("Chi ti·∫øt l·ªói:", data);
                return;
            }
            if (!data.users || !Array.isArray(data.users)) {
                 alert("L·ªói c·∫•u tr√∫c d·ªØ li·ªáu: Kh√¥ng t√¨m th·∫•y danh s√°ch 'users'. Ki·ªÉm tra l·∫°i t√™n Sheet.");
                 return;
            }
            // ----------------------------------

            appData = data;
            renderUserList(data.users);
        } catch (e) {
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Google Sheet. H√£y ki·ªÉm tra l·∫°i ƒë∆∞·ªùng link API_URL.");
            console.error(e);
        } finally {
            showLoader(false);
        }
    }

</script>

</body>

</html>



